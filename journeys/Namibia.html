<div class="map" style="grid-row: span 2" count="{{ images_sorted.size }}">
  <style>

    /* Demo content section */
    .intro-section {
      max-width: 1400px;
      margin: 0 auto;
      padding: 60px 40px;
      background: #2a2a2a;
      margin-bottom: 40px;
    }

    .intro-section h1 {
      color: #ff6b35;
      margin-bottom: 20px;
    }

    .intro-section p {
      line-height: 1.8;
      color: #ccc;
      margin-bottom: 15px;
    }

    /* Map container - now scrolls with content */
    .map-container {
      flex: 0 0 45%;
      position: sticky;
      top: 60px;
      height: fit-content;
      background: #2a2a2a;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .map-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    svg {
      width: 100%;
      height: auto;
    }

    /* The travel path with scroll animation */
    .travel-path {
      fill: none;
      stroke: #ff6b35;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 400;
      stroke-dashoffset: 400;
      animation: draw-path linear;
      animation-timeline: view();
      animation-range: entry 0% cover 100%;
    }

    @keyframes draw-path {
      from {
        stroke-dashoffset: 400;
      }
      to {
        stroke-dashoffset: 0;
      }
    }

    /* Fallback for browsers without CSS scroll-driven animations */
    @supports not (animation-timeline: view()) {
      .travel-path {
        /* JavaScript will handle this */
      }
    }

    .map-outline {
      fill: #3a3a3a;
      stroke: #555;
      stroke-width: 1;
    }

    .location-marker {
      fill: #ff6b35;
      transition: opacity 0.3s ease;
    }

    .location-label {
      fill: #fff;
      font-size: 10px;
      transition: opacity 0.3s ease;
    }

    .photo-section {
      margin-bottom: 60px;
      background: #2a2a2a;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .photo-section:last-child {
      margin-bottom: 0;
    }

    .photo-placeholder {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: rgba(255,255,255,0.9);
    }

    .photo-info {
      padding: 30px;
    }

    .photo-info h2 {
      margin-bottom: 10px;
      color: #ff6b35;
    }

    .photo-info p {
      line-height: 1.6;
      color: #ccc;
    }
  </style>

  <div class="map-container">
    <div class="map-wrapper">
      <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
        <!-- Simplified Namibia outline -->
        <path class="map-outline" d="M50,50 L250,50 L250,150 L280,150 L280,350 L50,350 L50,200 L20,200 L20,100 L50,100 Z"/>

        <!-- Travel path - animates as you scroll -->
        <path class="travel-path" d="M150,80 L200,120 L220,180 L180,240 L150,300 L100,280"/>

        <!-- Location markers -->
        <circle class="location-marker" cx="150" cy="80" r="6"/>
        <circle class="location-marker" cx="200" cy="120" r="6"/>
        <circle class="location-marker" cx="220" cy="180" r="6"/>
        <circle class="location-marker" cx="180" cy="240" r="6"/>
        <circle class="location-marker" cx="150" cy="300" r="6"/>
        <circle class="location-marker" cx="100" cy="280" r="6"/>

        <!-- Location labels -->
        <text class="location-label" x="160" y="78">Windhoek</text>
        <text class="location-label" x="210" y="118">Etosha</text>
        <text class="location-label" x="230" y="178">Skeleton Coast</text>
        <text class="location-label" x="190" y="238">Swakopmund</text>
        <text class="location-label" x="160" y="298">Sossusvlei</text>
        <text class="location-label" x="110" y="278">Fish River</text>
      </svg>
    </div>
  </div>
</div><script>
  // Check if CSS scroll-driven animations are supported
  const supportsScrollTimeline = CSS.supports('animation-timeline', 'view()');

  if (!supportsScrollTimeline) {
    // Fallback: Use JavaScript for scroll animation

    const scripts = document.getElementsByTagName('script');
    const currentScript = scripts[scripts.length - 1];
    const mapElement = currentScript.previousSibling;
    window.x = mapElement;

    const path = mapElement.querySelector('.travel-path');
    const pathLength = path.getTotalLength();
    const gallery = document.querySelector('.gallery');

    // Set initial state
    path.style.strokeDasharray = pathLength;
    path.style.strokeDashoffset = pathLength;

    const count = mapElement.getAttribute("count")

    function updatePath() {
      const columns = getComputedStyle(gallery).gridTemplateColumns.split(' ').length-1;
      mapElement.style.gridRow = "span " + Math.ceil(count/columns);

      const rect = mapElement.getBoundingClientRect();
      const containerTop = rect.top;
      const containerBottom = rect.bottom;
      const windowHeight = window.innerHeight;

      // Calculate when gallery enters and exits viewport
      const scrollStart = windowHeight;
      const scrollEnd = 0;

      // How far through the container are we?
      const totalDistance = containerBottom - containerTop;
      const scrolledDistance = scrollStart - containerTop;

      // Calculate progress (0 to 1)
      let scrollPercent = 0;
      if (totalDistance > 0) {
        scrollPercent = Math.max(0, Math.min(1, scrolledDistance / totalDistance));
      }

      const drawLength = pathLength * scrollPercent;
      path.style.strokeDashoffset = pathLength - drawLength;
    }

    // Update on scroll and resize
    window.addEventListener('scroll', updatePath);
    window.addEventListener('resize', updatePath);
    updatePath();
  }
</script>
