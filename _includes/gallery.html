<div class="gallery">
    {% assign images = site.static_files | where_exp: "file", "file.path contains 'fulls'" %}
    {% assign years = images | group_by_exp: "image", "image.path | split: '/' | slice: 2, 1 | first" %}

    {% for year in years reversed %}

    {% assign firstYear = forloop.first %}
    {% assign locations = year.items | group_by_exp: "image", "image.path | split: '/' | slice: 3, 1 | first" %}

    {% for location in locations reversed %}
    {% assign firstLoc = forloop.first %}
    {% assign locationName = location.name | split:"_" | last %}


    {%- comment -%} Extract suffix after ~ for sort key {%- endcomment -%}

        {% assign images_with_tilde = "" | split: "" %}
        {% assign images_without_tilde = "" | split: "" %}

        {% for f in location.items %}
            {% if f.name contains '~' %}
            {% assign images_with_tilde = images_with_tilde | push: f %}
            {% else %}
            {% assign images_without_tilde = images_without_tilde | push: f %}
            {% endif %}
            {% endfor %}

        {%- comment -%} Create sortable strings: "sortkey|index" {%- endcomment -%}
        {% assign tilde_sortable = "" | split: "" %}
        {% for f in images_with_tilde %}
            {% assign parts = f.name | split: "~" %}
            {% assign key = parts[1] | default: parts[0] %}
            {% assign sortable = key | append: "|" | append: forloop.index0 %}
            {% assign tilde_sortable = tilde_sortable | push: sortable %}
            {% endfor %}

        {% assign tilde_sortable_sorted = tilde_sortable | sort_natural %}

        {%- comment -%} Rebuild sorted array using indices {%- endcomment -%}
        {% assign images_with_tilde_sorted = "" | split: "" %}
        {% for sortable in tilde_sortable_sorted %}
            {% assign parts = sortable | split: "|" %}
            {% assign idx = parts[1] | plus: 0 %}
            {% assign images_with_tilde_sorted = images_with_tilde_sorted | push: images_with_tilde[idx] %}
            {% endfor %}

        {% assign images_without_tilde_sorted = images_without_tilde | sort_natural: "name" %}
        {% assign images_sorted = images_with_tilde_sorted | concat: images_without_tilde_sorted %}

    {% assign location_hint = locationName | append: ".html" %}
    {% assign location_hint_exists = site.static_files | where: "name", location_hint | first %}
    {% if location_hint_exists %}
    {% include_relative {{ location_hint_exists.path }} %}
    {% endif %}

    {% for image in images_sorted %}
    <div class="gallery-item" location="{{ locationName }}" year="{{ year.name }}">

        {% if forloop.first %}
        <a href="#p-{{ year.name }}-{{ locationName }}" class="location" location="{{ locationName }}" id="p-{{ year.name }}-{{ locationName }}">{{ locationName }}</a>
        {% if firstLoc %}
        <a href="#p-{{ year.name }}" class="year" year="{{ year.name }}" id="p-{{ year.name }}">{{ year.name }}</a>
        {% endif %}
        {% endif %}

        <a href="#p-{{ year.name }}-{{ locationName }}-{{ image.name }}" class="image">
            <img loading="lazy" src="{{ site.baseurl }}/{{site.image_root}}/{{ year.name }}/{{ location.name }}/{{ site.image_thumbs_loc }}/{{ image.name }}" alt="" data-name="{{ image.name }}"/>
        </a>
    </div>

    {% endfor %}
    {% endfor %}
    {% endfor %}

</div>